package ir.asta.training.contacts.manager;

import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import javax.inject.Inject;
import javax.inject.Named;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.core.Context;
import org.springframework.transaction.annotation.Transactional;
import ir.asta.training.contacts.dao.CaseDao;
import ir.asta.training.contacts.dao.UserDao;
import ir.asta.training.contacts.entities.CaseEntity;
import ir.asta.training.contacts.entities.UserEntity;
import ir.asta.wise.core.datamanagement.ActionResult;
import models.Status;
import org.json.JSONException;
import org.json.JSONObject;
import org.json.JSONTokener;

@Named("caseManager")
public class CaseManager {
	
	@Inject
	CaseDao dao;
	@Inject
	UserDao userDao;
	
	Status status = new Status();
	
	@Transactional
	public ActionResult<CaseEntity> postNewCase(String newCaseString) throws JSONException, ParseException{
		ActionResult<CaseEntity> answer = new ActionResult<CaseEntity>();
		CaseEntity newCase = this.caseEntityFactory(newCaseString);
		if(dao.save(newCase)){
			answer.setData(newCase);
			answer.setSuccess(true);
			answer.setMessage("مورد با موفقیت ثبت شد");
		}
		return answer;
	}
	@Transactional
	public CaseEntity caseEntityFactory(String newCaseString) throws JSONException, ParseException{
		JSONObject newCaseObj = new JSONObject(new JSONTokener(newCaseString));
		CaseEntity newCase = new CaseEntity();
		DateFormat formatter = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss Z");
		newCase.setContent(newCaseObj.getString("content"));
		newCase.setDate(formatter.parse(newCaseObj.getString("date")));
		newCase.setDescription(newCaseObj.getString("description"));
		newCase.setPoster_user(userDao.getUserByUsername(newCaseObj.getString("poster_username")));
		newCase.setResponsible_user(userDao.getUserByUsername(newCaseObj.getString("responsible_user")));
		newCase.setStatus(Status.OPEN);
		newCase.setTopic(newCaseObj.getString("topic"));
		return newCase;
	}
}
