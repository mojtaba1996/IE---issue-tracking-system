package ir.asta.training.contacts.dao;



import java.util.List;

import javax.inject.Inject;
import javax.inject.Named;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;

import ir.asta.training.contacts.entities.ContactEntity;
import ir.asta.training.contacts.entities.UserEntity;
import models.Roles;

@Named("userDao")
public class UserDao {
	
	@PersistenceContext
	private EntityManager entityManager;
	
	@Inject
	CaseDao caseDao;
	
	public boolean save(UserEntity user) {
		if (!entityManager.contains(user)){
			entityManager.persist(user);
			return true;
		}
		return false;
	}	
	
	public UserEntity exist(UserEntity user){
		Query q = entityManager.createQuery("select u from UserEntity u where u.username = :username", UserEntity.class);
		q.setParameter("username", user.getUsername());
		List<UserEntity> results = q.getResultList();
		if (results.size()==1){
			return results.get(0);
		}
		else{
			return null;
		}
	}
	
	public boolean deleteUser(UserEntity user){
		boolean answer = false;
		if (user != null){
			System.out.println(user.getUsername());
			caseDao.clearCases(user.getUsername());
			entityManager.remove(user);
			answer = true;
		}
		return answer;
	}
	
	public void clearAllUsers(){
		Query q = entityManager.createQuery("DELETE FROM UserEntity");
		q.executeUpdate();
	}
	
	public boolean isNewUsername(String username){
		Query q = entityManager.createQuery("select u from UserEntity u where u.username = :username");
		q.setParameter("username", username);
		List<UserEntity> result = q.getResultList();
		return result.size() == 0;
	}
	
	public List<UserEntity> getResponsibleUsers(){
		Roles roles = new Roles();
		Query q = entityManager.createQuery("select u from UserEntity u where u.role <> :role and u.confirmed = True", UserEntity.class);
		q.setParameter("role", roles.STUDENT);
		List<UserEntity> results = q.getResultList();
		return results;
	}
	
	public UserEntity getUserByUsername(String username){
		Query q = entityManager.createQuery("select u from UserEntity u where u.username = :username");
		q.setParameter("username", username);
		List<UserEntity> result = q.getResultList();
		if (result.size()>=1){ return result.get(0);}
		else { return null; }
	}
	
	public UserEntity getUserById(long id){
		Query q = entityManager.createQuery("SELECT u FROM UserEntity u WHERE u.id = :id");
		q.setParameter("id", id);
		List<UserEntity> result = q.getResultList();
		if (result.size()==1){ return result.get(0);}
		else { return null; }
	}
	
	public List<UserEntity> showMeAllUsers(){
		Query q = entityManager.createQuery("select u from UserEntity u");
		List<UserEntity> results = q.getResultList();
		return results;
	}
	
	public boolean updateUser(UserEntity user){
		if(entityManager.contains(user)){
			entityManager.merge(user);
			return true;
		}else{
			return false;
		}
	}
	
}
